# Target Function Approximation for Stochastic Circuit Minimization (TFASC)

This project implements the efficient method to find a minimized SC circuit with the approximation error over the target function satisfying the given error bound.

Related papers:
- [1]: Exploring Target Function Approximation for Stochastic Circuit Minimization (Chen Wang, Weihua Xiao, John P. Hayes, and Weikang Qian, ICCAD 2020)

## Important Notes

- Currently this program only includes the Dynamic Approximation (DA) method proposed in [1] as the best one among all the 3 proposed methods. Later on, we will add the remaining proposed Perturbation (PER) method and the Degree-Precision Scanning (DPS) method here.
- Since the program requires the EDA tools [ABC](http://people.eecs.berkeley.edu/~alanmi/abc/) and [MVSIS](https://ptolemy.berkeley.edu/projects/embedded/mvsis/), please download the appropriate executable files or compile the source codes in your OS. 
  - For ABC, suppose the absolute directory containing the executable file `abc` is `<abc_exe_absolute_directory>`. Then, before compiling the TFASC program, please set `ABC_EXE_ABSOLUTE_DIR` in the header file `define.h` as `<abc_exe_absolute_directory>`. Please compile the source codes from [here](https://github.com/berkeley-abc/abc) to obtain executable `abc` and put it into `<program_dir>/tool_dir/` before running the TFASC program.
  - For MVSIS, suppose the absolute directory containing the executable file `mvsis` is `<mvsis_exe_absolute_directory>`. Then, before compiling the TFASC program, please set `MVSIS_EXE_ABSOLUTE_DIR` in the header file `define.h` as `<mvsis_exe_absolute_directory>`. Note that [the original MVSIS source code](https://ptolemy.berkeley.edu/projects/embedded/mvsis/software.html) is out of date, which is only supported by a 32-bit Linux OS. In order to run on a modern 64-bit Linux OS, you can use the source codes [here](https://github.com/sterin/mvsis) (check [here](https://github.com/wangchen2011/mvsis) as a copy of the contents from the link if it does not work).
- This program also calls some PERL scripts for text parsing purpose. Therefore, please make sure PERL is installed on your OS.
- In the following part, we assume the user is at the <program_dir> directory when we describe the directories and the commands.

## Requirements

- OS: 64-bit Linux
- gcc
- g++
- make
- libreadline
- ctags
- PERL
- EDA logic synthesis tools: [ABC](http://people.eecs.berkeley.edu/~alanmi/abc/), [MVSIS](https://github.com/sterin/mvsis) executable files

## Input Format

For each target function, an input file should be prepared before execution.
Format of the content in the input file:
```
degree n
precision m
feature vector
```
For example, the content of the input file `bm1.2.txt` for `bm1.2` is:
```
4
8
0 254 771 723 215
```
where 4 on the first line is for degree `n = 4`, and 8 on the second line is for the precision parameter `m = 8`. On the third line is the input feature vector corresponding to the closest Bernstein polynomial approximating the target function. This input file can be directly generated by the Matlab program in [here](https://github.com/SJTU-ECTL/TFASC/tree/master/Bernstein%20polynomial%20approximation%20by%20Matlab).

## Program Organization

```
<abc_exe_absolute_directory>
| ----abc executable file

<mvsis_exe_absolute_directory>
| ----mvsis executable file

<program_dir>
| readme.md
| Makefile
|----src
|     |----(source files)
|----tool_dir
|     |----mcnc.genlib
|     |----mvsis (executable file)
|     |----abc (executable file)
|     |----(useful PERL scripts)
|----temp_dir
|     |----(temporary files)
|----obj
|----input_dir
|     |----demo_benchmarks
|     |----user_benchmarks
|----output_dir
|     |----demo_results
|     |     |----bm1.1
|     |     |----bm1.2
|     |     |----(and so on)
|     |----user_results
|     |     |----test1
|     |     |----(and so on)
```

- `<abc_exe_absolute_directory>`: user-defined directory (can be anywhere) containing the executable file of `ABC`. Set `ABC_EXE_ABSOLUTE_DIR` in the header file `<program_dir>/src/define.h` as `<abc_exe_absolute_directory>` before compilation.
- `<mvsis_exe_absolute_directory>`: user-defined directory (can be anywhere) containing the executable file of `MVSIS`. Set `MVSIS_EXE_ABSOLUTE_DIR` in the header file `<program_dir>/src/define.h` as `<mvsis_exe_absolute_directory>` before compilation.
- `src`: contains all source files and header files.
- `tool_dir`: contains the `mcnc.genlib` library for standard cell mapping. It also contains several PERL scripts for parsing the ABC/MVSIS results to obtain the reported literal count, delay, and area of the circuit. 
- `temp_dir`: contains temporary files generated during the running of the program.
- `obj`: automatically generated by the program.
- `input_dir`: contains two sub-folders, i.e., `demo_benchmarks` and `user_benchmarks`. `demo_benchmarks` contains the input files for all the benchmarks used in our paper [1], while `user_benchmarks` contains the input file(s) provided by the user.
- `output_dir`: contains two sub-folders, i.e., `demo_results` and `user_results`. `demo_results` contains the output files for all the benchmarks used in our paper [1] in each sub-folder such as `bm1.1`, `bm1.2`, etc., while `user_results` contains the sub-folders of the output file(s) corresponding to the input given by the user.
  The output files are:
  - `<bm_name>-solution-summary.txt`: overall summary of the solutions for `<bm_name>`.
  - `<bm_name>-solution-<num>.pla`: .pla file for the solution with number `<num>`.
  - `<bm_name>-solution<num>.v`: gate-level Verilog file for the solution with number `<num>`.
  - `<bm_name>_opt_sol_featureVec.txt`: feature vector for the best solution with minimum area-delay product (ADP) reported by ABC.
  - `bestSol_summary_detailed_ABC.txt`: summary of the best solution with minimum ADP reported by ABC.
  - `bestSol_summary_detailed_ESPRESSO.txt`: summary of the best solution with minimum SOP literal count reported by ESPRESSO.

## Compilation

There are two modes to run the program, i.e., the `demo` and the `user-defined` modes, and compilation is slightly different for them.
In the program directory `<program_dir>`:
- For the `demo` mode, type `make` to generate the executable `main` file. 
- For the `user-defined` mode, first modify the `<program_dir>/src/target_functions.cpp` by defining the user-defined target function (details are shown below). Then, type `make` to generate the executable `main` file. 

## Usage

There are two modes to run the program, i.e., the `demo` and the `user-defined` modes.
- For the `demo` mode, the user can run the program for the all the benchmarks used in our paper [1]:
  - Step 1: type `make` to compile the program.
  - Step 2: run the program by the command 
    ```
    ./main -demo <target function ID> <test group ID>
    ```
    where `<target function ID>` is a number between 1 and 12 for the following target functions
    ```
    target function ID    target function
    -------------------------------------
    1                     sin(x)
    2                     cos(x)
    3                     exp(-x)
    4                     log(x+1)
    5                     sin(Pi*x)/Pi
    6                     tanh(x)
    7                     tanh(4x)
    8                     x^0.45
    9                     exp(-2x)
    10                    1/(1+exp(-x))
    11                    x^2.2
    12                    0.5*cos(Pi*x)+0.5
    ```
    \<test group ID\> represents for one fo the 4 test groups with different degree n and precision m as
    ```
    test group ID     degree n      precision m
    -------------------------------------------
    1                 4             4
    2                 4             8
    3                 6             4
    4                 6             8
    ```
    Example: command `./main -demo 1 2` runs for the benchmark `bm1.2` for the target function `sin(x)` with `n = 4` and `m = 8`.
    All corresponding input files are provided at `./input_dir/demo_benchmarks/`.
    Note: `bm7.1` and `bm7.2` are ignored because their initial errors are larger than the given error bound, as discussed in our paper.
  - Step 3: check the results at `./output_dir/demo_results/bm<target function ID>.<test group ID>/`. For example, the results for the benchmark `bm1.2` are in `./output_dir/demo_results/bm1.2/`.

- For the "user-defined" mode, the user can run the program for a user-defined target function:
  - Step 1: before compilation, modify the function `double user_defined_target_function()` in `./src/target_functions.cpp` as the new user-defined target function. 
    For example, if the user-defined target function is `cos(2x)`, then modify this function as
    ```
    double user_defined_target_function(double x){
      return cos(2*x);
    }
    ```
  - Step 2: modify the program parameters in `./src/define.h` for quality-runtime tradeoff as follows.
  ```
  parameter in [1]      parameter in `./src/define.h`                     default value   
  --------------------------------------------------------------------------------------
  w                     LITERAL_LIMIT_PARAM_w                             2
  h                     X_COMB_PARAM_h                                    1
  k_{L}                 K_literal                                         4
  k_{E}                 K_ERROR                                           1
  \alpha                RELAXED_ERROR_BOUND_FACTOR                        1.02
  \beta                 TARGET_FUNCTION_L2NORM_RELATIVE_ERROR_BOUND       0.02
  ```
  - Step 3: compile the program by typing `make`.
  - Step 4: prepare the corresponding input file with the name `<input file name>` in the input directory `./input_dir/user_benchmarks/`. `<input file name>` is an arbitrary file name given by the user. For example, if the input file is `./input_dir/user_benchmarks/user_input.txt`, then `<input file name>` is `user_input.txt`. It should be in the required input format.
  - Step 5: run the program by the command 
  ```
  ./main -user <input file name> <test name>
  ```
  where `<test name>` is an arbitrary name given by the user, such as `test1`. Note that both `<input file name>` and `<test name>` do not allow spacing within them.
  For example, the command line
  ```
  ./main -user user_input.txt test1
  ```
  reads in the input file `./input_dir/user_benchmarks/user_input.txt` and generates the results at `./output_dir/user_results/test1/`.
  - Step 6: check the resuls at `./output_dir/user_results/<test name>/`.
  

  
  
